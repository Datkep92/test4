<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üìÑ Xem XML GDT ƒë·∫ßy ƒë·ªß</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px 8px; text-align: left; }
    th { background: #eee; }
    .header { margin-bottom: 15px; font-size: 15px; }
    .chiethau { color: #a00; font-style: italic; }
  </style>
</head>
<body>

<h2>üì• Nh·∫≠p file ZIP ch·ª©a XML h√≥a ƒë∆°n GDT (TT78)</h2>
<input type="file" id="zipInput" accept=".zip">
<button onclick="handleZip()">üìÇ X·ª≠ l√Ω ZIP</button>

<div id="info" class="header"></div>
<table id="table"></table>

<script>
function get(node, tag) {
  return node?.getElementsByTagName(tag)[0]?.textContent?.trim() || "";
}

async function handleZip() {
  const file = document.getElementById("zipInput").files[0];
  if (!file) return alert("Ch·ªçn file ZIP!");

  const zip = await JSZip.loadAsync(file);
  const xmlFile = Object.values(zip.files).find(f => f.name.endsWith(".xml"));
  if (!xmlFile) return alert("‚ùå Kh√¥ng t√¨m th·∫•y file XML!");

  const xmlText = await xmlFile.async("text");
  const parser = new DOMParser();
  const xml = parser.parseFromString(xmlText, "text/xml");

  const hdon = xml.getElementsByTagName("HDon")[0];
  const dlh = hdon?.getElementsByTagName("DLHDon")[0];
  const chung = dlh?.getElementsByTagName("TTChung")[0];
  const nd = dlh?.getElementsByTagName("NDHDon")[0];
  const nban = nd?.getElementsByTagName("NBan")[0];
  const nmua = nd?.getElementsByTagName("NMua")[0];
  const dshh = nd?.getElementsByTagName("DSHHDVu")[0];
  const ttoan = nd?.getElementsByTagName("TToan")[0];

  const info = {
    soHD: get(chung, "SHDon"),
    ngay: get(chung, "NLap"),
    mstNBan: get(nban, "MST"),
    tenNBan: get(nban, "Ten"),
    mstNMua: get(nmua, "MST"),
    tenNMua: get(nmua, "Ten"),
    tong: get(ttoan, "TgTTTBSo")
  };

  document.getElementById("info").innerHTML = `
    üßæ <b>Ng∆∞·ªùi mua:</b> ${info.tenNMua} (${info.mstNMua})<br>
    üè¢ <b>Ng∆∞·ªùi b√°n:</b> ${info.tenNBan} (${info.mstNBan})<br>
    üìÖ <b>Ng√†y:</b> ${info.ngay} ‚Äì <b>S·ªë Hƒê:</b> ${info.soHD}<br>
    üí∞ <b>T·ªïng ti·ªÅn:</b> ${info.tong}
  `;

  const rows = [...dshh.getElementsByTagName("HHDVu")].map(h => {
    return {
      loai: get(h, "TChat") === "2" ? "Chi·∫øt kh·∫•u" : "H√†ng h√≥a",
      stt: get(h, "STT"),
      ten: get(h, "THHDVu"),
      dvt: get(h, "DVTinh"),
      sl: get(h, "SLuong"),
      dg: get(h, "DGia"),
      thue: get(h, "TThue"),
      thanhtien: get(h, "ThTien"),
      tongtt: get(h.getElementsByTagName("TTKhac")[0], "Th√†nh ti·ªÅn thanh to√°n c·ªßa h√†ng h√≥a")
    };
  });

  const table = document.getElementById("table");
  table.innerHTML = `
    <tr>
      <th>STT</th><th>Lo·∫°i</th><th>T√™n h√†ng</th><th>SL</th><th>ƒêVT</th>
      <th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th><th>Thu·∫ø</th><th>T·ªïng TT</th>
    </tr>
    ${rows.map(r => `
      <tr class="${r.loai === 'Chi·∫øt kh·∫•u' ? 'chiethau' : ''}">
        <td>${r.stt}</td>
        <td>${r.loai}</td>
        <td>${r.ten}</td>
        <td>${r.sl}</td>
        <td>${r.dvt}</td>
        <td>${r.dg}</td>
        <td>${r.thanhtien}</td>
        <td>${r.thue}</td>
        <td>${r.tongtt}</td>
      </tr>
    `).join("")}
  `;
}
</script>

</body>
</html>