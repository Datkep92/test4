<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üßæ Test H√≥a ƒë∆°n XML GDT trong ZIP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .invoice { border: 1px solid #ccc; margin-top: 10px; padding: 10px; background: #f9f9f9; }
    pre { background: #eee; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>üì• Nh·∫≠p file ZIP ch·ª©a XML + HTML h√≥a ƒë∆°n GDT</h2>

  <label>üîê Token GitHub:
    <input id="tokenInput" placeholder="Personal Access Token" style="width:300px">
    <button onclick="saveToken()">üíæ L∆∞u token</button>
  </label><br><br>

  <input type="file" id="zipInput" accept=".zip">
  <button onclick="handleZIP()">üìÇ X·ª≠ l√Ω ZIP</button>

  <div id="output"></div>

  <script>
    const repo = "Datkep92/test4";
    const folder = "hoadon";

    function saveToken() {
      const token = document.getElementById("tokenInput").value;
      if (token) {
        localStorage.setItem("githubToken", token);
        alert("‚úÖ Token ƒë√£ l∆∞u.");
      }
    }

    async function handleZIP() {
      const file = document.getElementById("zipInput").files[0];
      const output = document.getElementById("output");
      if (!file) return alert("Ch·ªçn file ZIP tr∆∞·ªõc.");

      const zip = await JSZip.loadAsync(file);
      const xmlFile = Object.values(zip.files).find(f => f.name.endsWith(".xml"));
      const htmlFile = Object.values(zip.files).find(f => f.name.endsWith(".html"));

      if (!xmlFile || !htmlFile) {
        output.innerHTML = "<div class='invoice'>‚ùå Thi·∫øu file XML ho·∫∑c HTML</div>";
        return;
      }

      const xmlText = await xmlFile.async("text");
      const invoiceText = extractInvoiceContent(xmlText);
      const xml = new DOMParser().parseFromString(invoiceText, "text/xml");
      const htmlText = await htmlFile.async("text");

      const { info, hang } = extractXMLData(xml);
      const githubURL = await uploadToGitHub(htmlFile.name, htmlText);

      output.innerHTML = `
        <div class="invoice">
          <b>üßæ Ng∆∞·ªùi mua:</b> ${info.buyerName} (MST: ${info.buyerMST})<br>
          <b>üè¢ Ng∆∞·ªùi b√°n:</b> ${info.sellerName} (MST: ${info.sellerMST})<br>
          <b>üìÖ Ng√†y:</b> ${info.date} ‚Äì <b>S·ªë Hƒê:</b> ${info.number}<br>
          <b>üí∞ T·ªïng ti·ªÅn:</b> ${info.total}<br>
          <b>üîó HTML:</b> <a href="${githubURL}" target="_blank">${githubURL}</a>
          <pre>${hang.map(h =>
            `- ${h.stt}. ${h.ten} (${h.sl} ${h.dvt}) x ${h.dg} = ${h.tt}`
          ).join("\n")}</pre>
        </div>
      `;
    }

    function extractInvoiceContent(xmlText) {
      const start = xmlText.indexOf("<Invoice");
      const end = xmlText.indexOf("</Invoice>") + "</Invoice>".length;
      return xmlText.slice(start, end);
    }

    function extractXMLData(xml) {
      const nsCBC = "urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2";
      const nsCAC = "urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2";
      const get = (ns, tag, index = 0) =>
        xml.getElementsByTagNameNS(ns, tag)?.[index]?.textContent?.trim() || "";

      const info = {
        sellerName: get(nsCBC, "Name", 0),
        sellerMST: get(nsCBC, "CompanyID", 0),
        buyerName: get(nsCBC, "Name", 1),
        buyerMST: get(nsCBC, "CompanyID", 1),
        date: get(nsCBC, "IssueDate"),
        number: get(nsCBC, "ID"),
        total: get(nsCBC, "PayableAmount")
      };

      const lines = [...xml.getElementsByTagNameNS(nsCAC, "InvoiceLine")].map(line => {
        const qtyNode = line.getElementsByTagNameNS(nsCBC, "InvoicedQuantity")[0];
        return {
          stt: line.getElementsByTagNameNS(nsCBC, "ID")[0]?.textContent?.trim() || "",
          ten: line.getElementsByTagNameNS(nsCBC, "Name")[0]?.textContent?.trim() || "",
          dvt: qtyNode?.getAttribute("unitCode") || "",
          sl: qtyNode?.textContent?.trim() || "",
          dg: line.getElementsByTagNameNS(nsCBC, "PriceAmount")[0]?.textContent?.trim() || "",
          tt: line.getElementsByTagNameNS(nsCBC, "LineExtensionAmount")[0]?.textContent?.trim() || ""
        };
      });

      return { info, hang: lines };
    }

    async function uploadToGitHub(fileName, content) {
      const token = localStorage.getItem("githubToken");
      if (!token) {
        alert("‚ùå Ch∆∞a c√≥ token");
        return "#";
      }

      const path = `${folder}/${Date.now()}_${fileName}`;
      const api = `https://api.github.com/repos/${repo}/contents/${path}`;
      const res = await fetch(api, {
        method: "PUT",
        headers: {
          Authorization: "token " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "upload file",
          content: btoa(unescape(encodeURIComponent(content)))
        })
      });

      if (!res.ok) return "#";
      return `https://${repo.split("/")[0]}.github.io/${repo.split("/")[1]}/${path}`;
    }
  </script>
</body>
</html>