<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Hệ thống Quản lý HĐ và Kho</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  #header { background: #007BFF; color: white; padding: 10px; text-align: center; }
  #container { display: flex; height: calc(100vh - 50px); }
  #sidebar { width: 200px; background: #f0f0f0; padding: 10px; overflow-y: auto; }
  #main { flex: 1; padding: 10px; overflow-y: auto; }
  button.tab { display: block; width: 100%; margin-bottom: 5px; padding: 10px; cursor: pointer; }
  .tab-content { display: none; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 5px; text-align: left; }
  #logOutput { background: #111; color: #0f0; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; margin-top: 10px; }
</style>
</head>
<body>

<div id="header">
  <h2>Hệ thống Quản lý HĐ và Kho</h2>
  <input type="file" id="zipInput" multiple accept=".zip">
</div>

<div id="container">
  <div id="sidebar">
    <h3>Danh sách công ty</h3>
    <div id="companyList"></div>
    <button class="tab" data-tab="hoadon">Hoá đơn</button>
    <button class="tab" data-tab="tonkho">Kho</button>
    <button class="tab" data-tab="xuathang">Xuất hàng</button>
    <button class="tab" data-tab="ketoan">Kế toán</button>
  </div>
  <div id="main">
    <div id="hoadon" class="tab-content">
      <h3>Hoá đơn</h3>
      <table id="invoiceTable">
        <thead>
          <tr>
            <th>STT</th><th>MST</th><th>HĐ</th><th>Ngày</th><th>Trạng thái</th><th>Tổng tiền</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="tonkho" class="tab-content">
      <h3>Tồn kho</h3>
      <table id="stockTable">
        <thead>
          <tr>
            <th>MSP</th><th>Tên hàng</th><th>ĐVT</th><th>Số lượng</th><th>Đơn giá</th><th>Thành tiền</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="xuathang" class="tab-content">
      <h3>Xuất hàng</h3>
      <table id="exportTable">
        <thead>
          <tr>
            <th>MSP</th><th>Tên hàng</th><th>Số lượng xuất</th><th>Đơn giá</th><th>Thành tiền</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="ketoan" class="tab-content">
      <h3>Kế toán</h3>
      <table id="accountTable">
        <thead>
          <tr>
            <th>Loại</th><th>MST</th><th>Số tiền</th><th>Ngày</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="logOutput"></div>
  </div>
</div>

<!-- Thư viện JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="zip-trichxuat.js"></script>
<script src="hoadon.js"></script>
<script src="tonkho.js"></script>
<script src="xuathang.js"></script>
<script src="ketoan.js"></script>

<script>
// =======================
// UI Log
// =======================
window.logAction = function(msg){
  const log = document.getElementById('logOutput');
  const time = new Date().toLocaleTimeString();
  log.innerHTML += `[${time}] ${msg}<br>`;
  log.scrollTop = log.scrollHeight;
};

// =======================
// Tabs
// =======================
const tabs = document.querySelectorAll('button.tab');
const contents = document.querySelectorAll('.tab-content');
tabs.forEach(btn=>{
  btn.addEventListener('click',()=>{
    contents.forEach(c=>c.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
    renderTables(); // Render dữ liệu mỗi khi đổi tab
  });
});

// =======================
// Nhập ZIP
// =======================
document.getElementById('zipInput').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files);
  if(files.length>0){
    logAction('Đang xử lý ZIP...');
    await handleZipFiles(files);
    updateCompanyList();
    renderTables();
  }
});

// =======================
// Danh sách công ty
// =======================
function updateCompanyList(){
  const listDiv = document.getElementById('companyList');
  listDiv.innerHTML = '';
  Object.keys(hkdData).forEach(mst=>{
    const div = document.createElement('div');
    div.textContent = mst;
    listDiv.appendChild(div);
  });
}

// =======================
// Render các bảng
// =======================
function renderTables(){
  // Hoá đơn
  const invoiceTbody = document.querySelector('#invoiceTable tbody');
  invoiceTbody.innerHTML='';
  Object.keys(hkdData).forEach(mst=>{
    hkdData[mst].invoices.forEach((inv,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${idx+1}</td><td>${mst}</td><td>${inv.uniqueKey}</td><td>${inv.invoiceInfo.date}</td><td>${inv.status.validation}</td><td>${inv.totals.total.toLocaleString()}</td>`;
      invoiceTbody.appendChild(tr);
    });
  });

  // Tồn kho
  const stockTbody = document.querySelector('#stockTable tbody');
  stockTbody.innerHTML='';
  Object.keys(hkdData).forEach(mst=>{
    hkdData[mst].tonkhoMain.forEach(item=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${item.msp}</td><td>${item.name}</td><td>${item.unit}</td><td>${item.quantity}</td><td>${item.price.toLocaleString()}</td><td>${item.amount.toLocaleString()}</td>`;
      stockTbody.appendChild(tr);
    });
  });

  // Xuất hàng và Kế toán có thể render tương tự khi logic riêng được tích hợp
}
</script>

</body>
</html>