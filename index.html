<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trích xuất hóa đơn điện tử</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #1a73e8;
            text-align: center;
        }
        .upload-area {
            border: 2px dashed #1a73e8;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            border-radius: 5px;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .info-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .info-box {
            width: 48%;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .loading {
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Trích xuất hóa đơn điện tử</h1>
    
    <div class="upload-area" id="dropZone">
        <p>Kéo thả file ZIP chứa hóa đơn XML vào đây hoặc</p>
        <input type="file" id="zipFile" accept=".zip" style="display: none;">
        <button onclick="document.getElementById('zipFile').click()">Chọn file</button>
    </div>
    
    <div class="loading" id="loading">Đang xử lý...</div>
    
    <div id="invoiceInfo" style="display: none;">
        <h2>Thông tin hóa đơn</h2>
        <p><strong>Số hóa đơn:</strong> <span id="invoiceNumber"></span></p>
        <p><strong>Ngày lập:</strong> <span id="invoiceDate"></span></p>
        <p><strong>Mẫu số:</strong> <span id="invoiceTemplate"></span></p>
        
        <div class="info-section">
            <div class="info-box">
                <h3>Bên bán</h3>
                <p><strong>Tên:</strong> <span id="sellerName"></span></p>
                <p><strong>MST:</strong> <span id="sellerTaxCode"></span></p>
                <p><strong>Địa chỉ:</strong> <span id="sellerAddress"></span></p>
            </div>
            
            <div class="info-box">
                <h3>Bên mua</h3>
                <p><strong>Tên:</strong> <span id="buyerName"></span></p>
                <p><strong>MST:</strong> <span id="buyerTaxCode"></span></p>
                <p><strong>Địa chỉ:</strong> <span id="buyerAddress"></span></p>
            </div>
        </div>
        
        <h3>Bảng kê hàng hóa/dịch vụ</h3>
        <table id="productsTable">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Tên hàng hóa</th>
                    <th>Đơn vị</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const zipFileInput = document.getElementById('zipFile');
            const dropZone = document.getElementById('dropZone');
            
            // Xử lý khi chọn file
            zipFileInput.addEventListener('change', handleFile);
            
            // Xử lý kéo thả file
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.backgroundColor = '#f0f7ff';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.backgroundColor = '';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.backgroundColor = '';
                if (e.dataTransfer.files.length) {
                    zipFileInput.files = e.dataTransfer.files;
                    handleFile();
                }
            });
            
            // Hàm xử lý file
            async function handleFile() {
                const file = zipFileInput.files[0];
                if (!file || !file.name.endsWith('.zip')) {
                    alert('Vui lòng chọn file ZIP');
                    return;
                }
                
                document.getElementById('loading').style.display = 'block';
                
                try {
                    // Giải nén và đọc file XML
                    const zip = new JSZip();
                    const zipData = await zip.loadAsync(file);
                    
                    // Tìm file XML
                    let xmlFile;
                    for (const [filename, file] of Object.entries(zipData.files)) {
                        if (filename.endsWith('.xml')) {
                            xmlFile = file;
                            break;
                        }
                    }
                    
                    if (!xmlFile) throw new Error('Không tìm thấy file XML trong ZIP');
                    
                    const xmlContent = await xmlFile.async('text');
                    const invoiceData = parseXmlInvoice(xmlContent);
                    displayInvoice(invoiceData);
                    
                } catch (error) {
                    alert('Lỗi: ' + error.message);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }
            
            // Hàm phân tích XML
            function parseXmlInvoice(xmlContent) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                // Helper function
                const getText = (path, parent = xmlDoc) => {
                    const node = parent.querySelector(path);
                    return node ? node.textContent.trim() : '';
                };
                
                // Thông tin chung
                const invoiceInfo = {
                    number: getText('HDon > DLHDon > TTChung > SHDon'),
                    date: getText('HDon > DLHDon > TTChung > NLap'),
                    template: getText('HDon > DLHDon > TTChung > KHHDon')
                };
                
                // Thông tin người bán
                const sellerInfo = {
                    name: getText('HDon > DLHDon > NDHDon > NBan > Ten'),
                    taxCode: getText('HDon > DLHDon > NDHDon > NBan > MST'),
                    address: getText('HDon > DLHDon > NDHDon > NBan > DChi')
                };
                
                // Thông tin người mua
                const buyerInfo = {
                    name: getText('HDon > DLHDon > NDHDon > NMua > Ten'),
                    taxCode: getText('HDon > DLHDon > NDHDon > NMua > MST'),
                    address: getText('HDon > DLHDon > NDHDon > NMua > DChi')
                };
                
                // Danh sách hàng hóa
                const products = [];
                const productNodes = xmlDoc.querySelectorAll('HDon > DLHDon > NDHDon > DSHHDVu > HHDVu');
                
                productNodes.forEach(node => {
                    products.push({
                        name: getText('THHDVu', node),
                        unit: getText('DVTinh', node),
                        quantity: getText('SLuong', node),
                        price: getText('DGia', node),
                        amount: getText('ThTien', node)
                    });
                });
                
                return { invoiceInfo, sellerInfo, buyerInfo, products };
            }
            
            // Hiển thị hóa đơn
            function displayInvoice(data) {
                // Thông tin hóa đơn
                document.getElementById('invoiceNumber').textContent = data.invoiceInfo.number;
                document.getElementById('invoiceDate').textContent = data.invoiceInfo.date;
                document.getElementById('invoiceTemplate').textContent = data.invoiceInfo.template;
                
                // Thông tin người bán
                document.getElementById('sellerName').textContent = data.sellerInfo.name;
                document.getElementById('sellerTaxCode').textContent = data.sellerInfo.taxCode;
                document.getElementById('sellerAddress').textContent = data.sellerInfo.address;
                
                // Thông tin người mua
                document.getElementById('buyerName').textContent = data.buyerInfo.name;
                document.getElementById('buyerTaxCode').textContent = data.buyerInfo.taxCode;
                document.getElementById('buyerAddress').textContent = data.buyerInfo.address;
                
                // Bảng hàng hóa
                const tbody = document.querySelector('#productsTable tbody');
                tbody.innerHTML = '';
                
                data.products.forEach((product, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${product.name}</td>
                        <td>${product.unit}</td>
                        <td>${product.quantity}</td>
                        <td>${formatNumber(product.price)}</td>
                        <td>${formatNumber(product.amount)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('invoiceInfo').style.display = 'block';
            }
            
            // Định dạng số
            function formatNumber(num) {
                if (!num) return '0';
                return parseFloat(num).toLocaleString('vi-VN');
            }
        });
    </script>
</body>
</html>