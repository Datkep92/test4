<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Hệ thống Hóa đơn & Kho</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  #sidebar { width: 200px; float: left; background: #f0f0f0; height: 100vh; padding: 10px; box-sizing: border-box;}
  #main { margin-left: 210px; padding: 10px; }
  button { margin: 2px; padding: 5px 10px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px;}
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 5px; text-align: center; }
  #log { height: 100px; overflow-y: auto; border:1px solid #ccc; padding:5px; margin-top:10px; background:#fafafa; font-size:12px; }
  .tab { display:none; }
  .tab.active { display:block; }
</style>
</head>
<body>

<div id="sidebar">
  <h3>Danh sách công ty</h3>
  <div id="companyList"></div>
  <hr>
  <input type="file" id="zipFiles" multiple accept=".zip">
  <p><small>Upload ZIP hóa đơn</small></p>
  <hr>
  <button onclick="showTab('hoadon')">Hóa đơn</button>
  <button onclick="showTab('tonkho')">Tồn kho</button>
  <button onclick="showTab('xuathang')">Xuất hàng</button>
  <button onclick="showTab('ketoan')">Kế toán</button>
</div>

<div id="main">
  <h2>Hệ thống Hóa đơn & Kho</h2>

  <div id="log"></div>

  <!-- Tab Hóa đơn -->
  <div id="hoadon" class="tab">
    <h3>Danh sách Hóa đơn</h3>
    <table>
      <thead>
        <tr>
          <th>Ký hiệu</th><th>Số HĐ</th><th>Ngày</th>
          <th>Người bán</th><th>Người mua</th>
          <th>Trước thuế</th><th>Thuế</th><th>Tổng</th>
          <th>Trạng thái</th><th>Ngày trích xuất</th>
        </tr>
      </thead>
      <tbody id="hoadonTableBody"></tbody>
    </table>
  </div>

  <!-- Tab Tồn kho -->
  <div id="tonkho" class="tab">
    <h3>Chi tiết tồn kho</h3>
    <table>
      <thead>
        <tr>
          <th>MSP</th><th>Tên SP</th><th>ĐVT</th>
          <th>Số lượng</th><th>Đơn giá</th><th>Thành tiền</th>
        </tr>
      </thead>
      <tbody id="tonkhoTableBody"></tbody>
    </table>
  </div>

  <!-- Tab Xuất hàng -->
  <div id="xuathang" class="tab">
    <h3>Xuất hàng</h3>
    <p>Chọn công ty và MSP để xuất hàng</p>
    <select id="selectCompanyExport"></select>
    <input type="text" id="exportMsp" placeholder="MSP">
    <input type="number" id="exportQty" placeholder="Số lượng">
    <button onclick="doExport()">Xuất</button>
  </div>

  <!-- Tab Kế toán -->
  <div id="ketoan" class="tab">
    <h3>Bảng Kế toán</h3>
    <table>
      <thead>
        <tr>
          <th>Hóa đơn</th><th>Ngày</th>
          <th>Trước thuế</th><th>Chiết khấu</th><th>Thuế</th><th>Tổng</th>
        </tr>
      </thead>
      <tbody id="accountingTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Thư viện JSZip -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Các file JS -->
<script src="zip-trichxuat.js"></script>
<script src="hoadon.js"></script>
<script src="tonkho.js"></script>
<script src="xuathang.js"></script>
<script src="ketoan.js"></script>

<script>
  // ==========================
  // Hàm log lên UI
  // ==========================
  window.logAction = function(msg){
    const log = document.getElementById('log');
    if(log){
      const p = document.createElement('div');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      log.appendChild(p);
      log.scrollTop = log.scrollHeight;
    }
    console.log(msg);
  }

  // ==========================
  // Upload ZIP tự xử lý
  // ==========================
  document.getElementById('zipFiles').addEventListener('change', async (e)=>{
    const files = e.target.files;
    if(files.length>0){
      logAction('Đang xử lý ZIP...');
      await handleZipFiles(files);
      renderCompanyList();
      renderAllStock();
      logAction('Hoàn tất xử lý ZIP');
    }
  });

  // ==========================
  // Hiển thị tab
  // ==========================
  function showTab(tabId){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    const tab = document.getElementById(tabId);
    if(tab) tab.classList.add('active');
  }
  showTab('hoadon'); // mặc định hiển thị Hóa đơn

  // ==========================
  // Xuất hàng
  // ==========================
  function doExport(){
    const taxCode = document.getElementById('selectCompanyExport').value;
    const msp = document.getElementById('exportMsp').value.trim();
    const qty = parseFloat(document.getElementById('exportQty').value);
    if(!taxCode||!msp||isNaN(qty)||qty<=0){ logAction('Vui lòng nhập đầy đủ thông tin xuất'); return; }
    exportStock(taxCode,msp,qty);
  }

  // ==========================
  // Render select công ty cho xuất hàng
  // ==========================
  function renderCompanySelect(){
    const sel = document.getElementById('selectCompanyExport');
    if(!sel) return;
    sel.innerHTML='';
    Object.keys(hkdData).forEach(tax=>{
      const opt=document.createElement('option');
      opt.value=tax; opt.textContent=tax;
      sel.appendChild(opt);
    });
  }

  setInterval(renderCompanySelect,1000); // cập nhật tự động khi có công ty mới
</script>
</body>
</html>